<html>
<!-- CSS -->
<link rel="stylesheet" href="static/css/bootstrap.min.css">
<!-- <link rel="stylesheet" href="/static/css/custom.css"> -->

<!-- General Scripts -->
<script src="static/js/jquery-3.4.1.min.js"></script>
<script src="static/js/bootstrap.bundle.min.js"></script>

<script>
    const expression = /OverrideNamedEngramEntries=(.*)/g;

    function setupHides(hideInput) {
        if (!hideInput) {
            return []
        }

        var engramsToHide = hideInput.split("\n");

        var engramsToHideRe = []
        engramsToHide.forEach(function(eHide) {
            engramsToHideRe.push(new RegExp(eHide))
        })

        return engramsToHide
    }

    function filterEngrams(serverEngrams, engramRE) {
        var postParse = []
        serverEngrams.forEach(function(sEngram) {
            var match = engramsToHideRe.some(function(eHideRe, index) {
                if (sEngram.match(eHideRe)) {
                    return true;
                } else {
                    return false
                }
            })

            if (!match) {
                postParse.push(sEngram)
            }
        })

        postParse.sort()
        return postParse.join("\n")
    }

    function sortInPlace(id) {
        let toSort = document.getElementById(id)
        toSort.value = toSort.value.split("\n").sort().join("\n")
        return toSort.value
    }

    function parseServerOutput() {
        var serverOutput = document.getElementById("serverOutput").value
        var serverEngrams = serverOutput.match(expression)

        if (!serverEngrams) {
            alert("Invalid server output input.")
            return
        }

        toHide = sortInPlace("toHide")
        engramsToHideRe = setupHides(toHide)

        postParse = filterEngrams(serverEngrams, engramsToHideRe)

        if (document.getElementById("noLevels").checked) {
            postParse = postParse.replace(/(EngramLevelRequirement=)\d*/g, "$10")
        }

        if (document.getElementById("noCost").checked) {
            postParse = postParse.replace(/(EngramPointsCost=)\d*/g, "$10")
        }

        if (document.getElementById("noPreReqs").checked) {
            postParse = postParse.replace(/(RemoveEngramPreReq=)false/g, "$1true")
        }

        document.getElementById("postParse").value = postParse
        $('#myTabs a[href="#output"]').tab('show')
    }

    function getInputs(id) {
        var inputsGroups = document.getElementById(id).getElementsByClassName('input-group')

        var retObj = []

        for (i = 0; i < inputsGroups.length; i++) {
            var inputs = inputsGroups[i].getElementsByTagName('input')

            var holder = {}
            for (x = 0; x < inputs.length; x++) {
                holder[inputs[x].id] = inputs[x].value
            }

            retObj.push(holder)
        }

        return retObj
    }

    function duplicateInputBoxs(id) {
        var ele = document.getElementById(id)
        var clone = ele.cloneNode(true)

        var bottomEle = ele.parentNode.lastElementChild

        var newId = bottomEle.id
        newId = newId.replace(/\d+/, parseInt(newId.match(/\d+/g)) + 1)
        clone.setAttribute( 'id', newId );

        var inputs = clone.getElementsByTagName('input')
        var autofillCount = 1
        for (i = 0; i < inputs.length; i++) {
            if (arguments.length > 1) {
                if ((autofillCount > inputs.length) || (autofillCount > arguments.length - 1)) {
                    inputs[i].value = ""
                } else {
                    inputs[i].value = arguments[autofillCount]
                }
                autofillCount += 1
            } else {
                inputs[i].value = ""
            }
        }

        bottomEle.after(clone)
    }

    function exportToJson() {
        var exObject = {}
        var holder

        // Engrams to hide
        holder = sortInPlace("toHide").split("\n")
        if (holder) {
            exObject.EngramsToHide = holder
        }

        // Level Mods
        holder = getInputs('levelmods')
        if (holder) {
            exObject.LevelMods = holder
        }

        // Cost Mods
        holder = getInputs('costmods')
        if (holder) {
            exObject.CostMods = holder
        }

        // Prereqs Mods
        holder = getInputs('prereqsmods')
        if (holder) {
            exObject.PrereqsMods = holder
        }

        // Find and Replace Mods
        holder = getInputs('findreplace')
        if (holder) {
            exObject.FindReplace = holder
        }

        console.log(exObject)
        if (!exObject) { return }
        var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exObject, null, 2))
        var dlAnchorElem = document.getElementById('downloadAnchorElem')
        dlAnchorElem.setAttribute("href", dataStr)
        dlAnchorElem.setAttribute("download", "ARKEngramHelperExport.json")
        dlAnchorElem.click()
    }

    function jsonPopulateForms(id, data) {
        ele = document.getElementById(id)
        if (data) {
            // Is it an array of strings or not
            if (typeof(data[0]) == "string") {
                ele.value = data.join("\n")
            } else if (typeof(data[0]) == "object") {
                for (var i = 0; i < data.length; i++) {
                    var holder = []
                    for (const [key, value] of Object.entries(data[i])) {
                        holder.push(value)
                    }

                    duplicateInputBoxs(id, ...holder)
                }
            }
        }

    }

    function importFromJson(files) {
        try {
            if (!files.length) {
                alert('No file selected!');
                return
            }

            let file = files[0]
            let reader = new FileReader()
            const self = this
            reader.onload = (event) => {
                var importedJson = JSON.parse(event.target.result)

                if (importedJson.EngramsToHide) {
                    jsonPopulateForms("toHide", importedJson.EngramsToHide)
                } 

                if (importedJson.LevelMods) {
                    jsonPopulateForms("levelmodsinputs1", importedJson.LevelMods)
                }

                if (importedJson.CostMods) {
                    jsonPopulateForms("costmodsinputs1", importedJson.CostMods)
                }

                if (importedJson.PrereqsMods) {
                    jsonPopulateForms("prereqsmodsinputs1", importedJson.PrereqsMods)
                }

                if (importedJson.FindReplace) {
                    jsonPopulateForms("findreplaceinputs1", importedJson.FindReplace)
                }
            }
            reader.readAsText(file)
        } catch (err) {
            console.error(err)
        }
    }
</script>
<br>
<div class="form-horizontal">
    <div class="form-group">
        <div class="col-auto">
            <!-- Tabs -->
            <ul class="nav nav-tabs" id="myTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#inputs">Inputs</a>
                </li>
                <!-- <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#levelmods">Level mods</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#costmods">Cost mods</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#prereqsmods">Pre-Requirements mods</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#findreplace">Find and Replace</a>
                </li> -->
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#eximport">Export/Import</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#output">Outputs</a>
                </li>
                <li class="nav-item ml-auto">
                    <a class="nav-link" data-toggle="tab" href="#about">About</a>
                </li>
            </ul>
            <div id="myTabContent" class="tab-content">
                <div class="tab-pane fade active show" id="inputs">
                    <form action="javascript:parseServerOutput()">
                        <!-- Server output -->
                        <label class="col-form-label col-form-label-lg" for="serverOutput">Server output:</label>
                        <textarea class="form-control" rows="10" required id="serverOutput"></textarea>
                        <br>

                        <!-- Engrams to hide -->
                        <label class="col-form-label col-form-label-lg" for="toHide">Engrams to hide (newline seperated) (regex):</label>
                        <textarea class="form-control" rows="10" placeholder="&quot;EngramEntry_Bow_C&quot;&#13;&#10;&quot;EngramEntry_WeaponWhip_C&quot;" id="toHide"></textarea>
                        <br>

                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="noLevels"/>
                            <label class="custom-control-label" for="noLevels">Remove Level Requirements</label>
                        </div>

                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="noCost"/>
                            <label class="custom-control-label" for="noCost">Remove Point Cost</label>
                        </div>

                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="noPreReqs"/>
                            <label class="custom-control-label" for="noPreReqs">Remove Pre-Requirements</label>
                        </div>
                        <br>

                        <!-- Submit button -->
                        <input type="submit" value="Submit">
                    </form>
                </div>

                <!-- Level Mods -->
                <div class="tab-pane fade" id="levelmods">
                    <label class="col-form-label col-form-label-lg w-25">Engram (regex)</label>
                    <label class="col-form-label col-form-label-lg w-25">Level</label>
                    <form action="javascript:parseServerOutput()">
                        <div class="input-group w-50" id="levelmodsinputs1">
                            <input type="text" class="form-control w-25" id="engram" placeholder="&quot;EngramEntry_Bow_C&quot;">
                            <span class="input-group-addon"></span>
                            <input type="text" class="form-control w-25" id="level" placeholder="50"/>
                        </div>
                    </form>
                    <button class="btn btn-primary" onclick="(duplicateInputBoxs('levelmodsinputs1'))">+</button>
                </div>

                <!-- Cost Mods -->
                <div class="tab-pane fade" id="costmods">
                    <label class="col-form-label col-form-label-lg w-25">Engram (regex)</label>
                    <label class="col-form-label col-form-label-lg w-25">Cost</label>
                    <form action="javascript:parseServerOutput()">
                        <div class="input-group w-50" id="costmodsinputs1">
                            <input type="text" class="form-control w-25" id="engram" placeholder="&quot;EngramEntry_Bow_C&quot;">
                            <span class="input-group-addon"></span>
                            <input type="text" class="form-control w-25" id="Cost" placeholder="50"/>
                        </div>
                    </form>
                    <button class="btn btn-primary" onclick="(duplicateInputBoxs('costmodsinputs1'))">+</button>
                </div>

                <!-- Prereqs Mods -->
                <div class="tab-pane fade" id="prereqsmods">
                    <label class="col-form-label col-form-label-lg w-25">Engram (regex)</label>
                    <form action="javascript:parseServerOutput()">
                        <div class="input-group w-25" id="prereqsmodsinputs1">
                            <input type="text" class="form-control" id="engram" placeholder="&quot;EngramEntry_Bow_C&quot;">
                        </div>
                    </form>
                    <button class="btn btn-primary" onclick="(duplicateInputBoxs('prereqsmodsinputs1'))">+</button>
                </div>

                <!-- Find and replace -->
                <div class="tab-pane fade" id="findreplace">
                    <label class="col-form-label col-form-label-lg w-25">Find (regex)</label>
                    <label class="col-form-label col-form-label-lg w-25">Replace ($# for capture groups)</label>
                    <form action="javascript:parseServerOutput()">
                        <div class="input-group w-50" id="findreplaceinputs1">
                            <input type="text" class="form-control w-25" id="find" placeholder="&quot;EngramEntry_Bow_C&quot;">
                            <span class="input-group-addon"></span>
                            <input type="text" class="form-control w-25" id="replace" placeholder="50"/>
                        </div>
                    </form>
                    <button class="btn btn-primary" onclick="(duplicateInputBoxs('findreplaceinputs1'))">+</button>
                </div>

                <!-- Export/Import -->
                <div class="tab-pane fade" id="eximport">
                    <br>
                    <button class="btn btn-primary" onclick="(exportToJson())">Export</button>
                    <input id="contentFile" type="file" accept="application/json" accept=".json" onchange="importFromJson(this.files)" />
                    <a id="downloadAnchorElem" style="display:none"></a>
                </div>

                <div class="tab-pane fade" id="output">
                    <!-- Post process read only textbox -->
                    <label class="col-form-label col-form-label-lg" for="postParse">Post processing:</label>
                    <textarea class="form-control" rows="27" id="postParse" readonly=""></textarea>
                </div>

                <div class="tab-pane fade w-50 p-5" id="about">
                    <h1 style="text-decoration: underline;">About</h1>
                    <p>
                        This website was developed primarily for use with my <a href="https://steamcommunity.com/sharedfiles/filedetails/?id=2100040774">GetEngrams (Engram hider utility)</a> ARK: Survival Evolved mod. The value over using the GetEngrams mod is that it results in a lag-free method of hiding/modifying engrams. Only issue with this method is that it is a whitelist-style technique, and getting a list of all engrams prior to this mod was VERY tedious. GetEngrams plus this website will allow a server administrator to have full control over all engram settings for their server.
                    </p>
                    <br>
                    <p>
                        The end goal of the website is to be a one stop shop for all engram modifications that a server administrator could want.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
</html>